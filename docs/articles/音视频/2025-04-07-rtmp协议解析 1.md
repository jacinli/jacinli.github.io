# ä»‹ç»

## **ðŸ“– ä»€ä¹ˆæ˜¯ RTMPï¼Ÿ**

RTMPåè®®ï¼ˆReal-Time Messaging Protocolï¼Œå®žæ—¶æ¶ˆæ¯ä¼ è¾“åè®®ï¼‰æ˜¯ç”±Adobeå…¬å¸ï¼ˆæœ€åˆç”±Macromediaå¼€å‘ï¼‰è®¾è®¡çš„ä¸€ç§ç”¨äºŽå®žæ—¶ä¼ è¾“éŸ³é¢‘ã€è§†é¢‘å’Œæ•°æ®æµçš„ç½‘ç»œåè®®ï¼Œä¸»è¦ç”¨äºŽç›´æ’­å’Œæµåª’ä½“ä¼ è¾“,æœ€åˆæ˜¯ä¸ºäº†è®© Flash Player å’Œ Flash Media Server ä¹‹é—´è¿›è¡ŒéŸ³è§†é¢‘å’Œæ•°æ®çš„å®žæ—¶ä¼ è¾“ã€‚

çŽ°åœ¨è™½ç„¶ Flash è¢«æ·˜æ±°äº†ï¼Œä½† RTMP è¿™ä¸ªåè®®å› ä¸ºå…¶**ç®€å•ã€ä½Žå»¶è¿Ÿã€ç¨³å®š**çš„ç‰¹ç‚¹ï¼Œä¾ç„¶åœ¨ç›´æ’­é¢†åŸŸå¹¿æ³›åº”ç”¨ï¼Œæ¯”å¦‚ OBS æŽ¨æµã€æ–—é±¼ã€Bilibiliã€Twitch éƒ½åœ¨ç”¨ã€‚

```
â€¢	ä½œç”¨ï¼šRTMPç”¨æ¥å®žçŽ°éŸ³è§†é¢‘æ•°æ®çš„å®žæ—¶ä¼ è¾“ï¼Œæ¯”å¦‚ç›´æ’­è§†é¢‘ã€åœ¨çº¿éŸ³é¢‘ç­‰ã€‚å®ƒè®©å®¢æˆ·ç«¯ï¼ˆå¦‚æ’­æ”¾å™¨ï¼‰å’ŒæœåŠ¡å™¨ä¹‹é—´èƒ½å¿«é€Ÿã€è¿žç»­åœ°äº¤æ¢å¤šåª’ä½“æ•°æ®ã€‚
â€¢	å·¥ä½œå±‚çº§ï¼šRTMPæ˜¯åº”ç”¨å±‚åè®®ï¼Œä¾èµ–åº•å±‚çš„ä¼ è¾“å±‚åè®®ï¼ˆé€šå¸¸æ˜¯TCPï¼‰æ¥ä¿è¯æ•°æ®å¯é ä¼ è¾“ã€‚
â€¢	é»˜è®¤ç«¯å£ï¼šé€šå¸¸ä½¿ç”¨TCPçš„1935ç«¯å£è¿›è¡Œé€šä¿¡ï¼Œä¹Ÿæœ‰å˜ç§æ”¯æŒé€šè¿‡HTTPç«¯å£ï¼ˆ80ã€443ï¼‰ä¼ è¾“ä»¥ç©¿é€é˜²ç«å¢™ã€‚
â€¢	å¤šè·¯å¤ç”¨å’Œåˆ†åŒ…ï¼šRTMPä¼šæŠŠæ•°æ®åˆ†æˆè®¸å¤šå°å—ï¼ˆç§°ä¸ºChunkï¼‰ï¼Œæ¯ä¸ªChunkå¸¦æœ‰æ ‡è¯†ä¿¡æ¯ï¼ŒæŽ¥æ”¶ç«¯å†æŠŠè¿™äº›Chunkç»„è£…æˆå®Œæ•´çš„æ¶ˆæ¯ï¼Œå®žçŽ°å¤šè·¯å¤ç”¨å’Œé«˜æ•ˆä¼ è¾“ã€‚
â€¢	åŒå‘é€šä¿¡ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å¯ä»¥ç›¸äº’å‘é€å‘½ä»¤å’Œæ•°æ®ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯å‘å‡ºâ€œæ’­æ”¾â€ã€â€œæš‚åœâ€å‘½ä»¤ï¼ŒæœåŠ¡å™¨åˆ™æŽ¨é€è§†é¢‘æµã€‚

```

 RTMP æ’­æ”¾ï¼Œæµè§ˆå™¨ç«¯å·²ç»ä¸æ”¯æŒï¼ˆéœ€è¦ Flashï¼Œå·²ç»æ·˜æ±°ï¼‰ã€‚

**ðŸ› ï¸ RTMP çš„æ ¸å¿ƒç‰¹ç‚¹**

| **ç‰¹ç‚¹** | **è¯´æ˜Ž** |
| --- | --- |
| ä½Žå»¶è¿Ÿ | é€šå¸¸èƒ½åšåˆ° 1-2 ç§’ï¼Œéžå¸¸é€‚åˆç›´æ’­ |
| åˆ†å—ä¼ è¾“ | å¤§æ–‡ä»¶ï¼ˆæ¯”å¦‚è§†é¢‘æµï¼‰ä¼šè¢«åˆ‡æˆå°å—ï¼Œå®žæ—¶ä¼ è¾“ |
| æ”¯æŒéŸ³è§†é¢‘åŒæ­¥ | å¯ä»¥åŒæ—¶ä¼ è¾“éŸ³é¢‘ã€è§†é¢‘ã€æ–‡å­—æ•°æ®ï¼Œä¿æŒåŒæ­¥ |
| åŸºäºŽ TCP | ä¼ è¾“å¯é ï¼Œä¸ä¼šä¸¢åŒ…ï¼Œä½†é€Ÿåº¦æ¯” UDP ç¨æ…¢ä¸€ç‚¹ |
| æŒä¹…è¿žæŽ¥ | å»ºç«‹ä¸€æ¬¡è¿žæŽ¥åŽé•¿æ—¶é—´ä¿æ´»ï¼Œé€‚åˆæµå¼æ•°æ® |

## **ðŸ“¦ RTMP çš„æ•°æ®æµç¨‹**

RTMP æ•´ä¸ªé€šä¿¡è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š

1. **Handshakeï¼ˆæ¡æ‰‹é˜¶æ®µï¼‰**
    - å»ºç«‹ TCP è¿žæŽ¥åŽï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡æ¡æ‰‹ç¡®è®¤å½¼æ­¤åè®®ç‰ˆæœ¬ï¼Œå®Œæˆåˆå§‹åŒ–ã€‚
2. **Connectï¼ˆè¿žæŽ¥é˜¶æ®µï¼‰**
    - å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª connect å‘½ä»¤ï¼Œè¯·æ±‚æŽ¨æµæˆ–æ‹‰æµï¼Œæ¯”å¦‚æŒ‡å®šåº”ç”¨åï¼ˆappï¼‰ã€æµåï¼ˆstreamNameï¼‰ã€è®¤è¯ä¿¡æ¯ï¼ˆtokenï¼‰ç­‰ã€‚
3. **Streamï¼ˆæ•°æ®ä¼ è¾“é˜¶æ®µï¼‰**
    - å¼€å§‹éŸ³è§†é¢‘æ•°æ®ä¼ è¾“ï¼Œæ¯”å¦‚æŽ¨é€ h264 ç¼–ç çš„è§†é¢‘æµã€AAC ç¼–ç çš„éŸ³é¢‘æµï¼Œè¿˜æœ‰ä¸€äº›æŽ§åˆ¶æ¶ˆæ¯ï¼ˆæ¯”å¦‚ pauseã€seekã€metadata æ›´æ–°ï¼‰ã€‚

**ðŸ”¥ å¸¸è§çš„ RTMP ä½¿ç”¨åœºæ™¯**

| **åœºæ™¯** | **ç¤ºä¾‹** |
| --- | --- |
| ç›´æ’­æŽ¨æµ | OBS æŽ¨æµåˆ°æ–—é±¼ã€è™Žç‰™ã€Bç«™ |
| ç›´æ’­æ‹‰æµ | æ’­æ”¾å™¨ä»ŽæœåŠ¡å™¨æ‹‰ RTMP æµ |
| æµåª’ä½“æœåŠ¡å™¨å†…éƒ¨é€šä¿¡ | Nginx-RTMPã€SRSã€Red5ã€Wowza ç­‰æœåŠ¡å™¨ä½¿ç”¨ |
| å®žæ—¶å¼¹å¹•æŽ¨é€ | ç”¨ RTMP çš„ data message åŠŸèƒ½ |

## **ðŸ“¡ RTMP URL çš„æ ¼å¼**

```python
rtmp://æœåŠ¡å™¨åœ°å€:ç«¯å£å·/app/stream
```

## **ðŸ” RTMP çš„å‡ ä¸ªå­åè®®**

| **åè®®** | **è¯´æ˜Ž** |
| --- | --- |
| RTMPT | æŠŠ RTMP å°è£…æˆ HTTP è¯·æ±‚ï¼ˆç«¯å£80ï¼Œç©¿é˜²ç«å¢™ï¼‰ |
| RTMPS | åŠ å¯†ç‰ˆ RTMPï¼Œç”¨ SSL/TLS |
| RTMPE | Adobe è‡ªå·±çš„åŠ å¯†ç‰ˆ RTMPï¼ŒåŠå¼€æº |

âš¡ çŽ°åœ¨æœ€æµè¡Œçš„ä¸€ç§ç»„åˆæ˜¯ï¼š

- **æŽ¨æµç”¨ RTMP**ï¼ˆå®¢æˆ·ç«¯æŽ¨åˆ°æœåŠ¡å™¨ï¼‰
- **æ’­æ”¾ç”¨ HLS æˆ– WebRTC**ï¼ˆæœåŠ¡å™¨è½¬ç è¾“å‡ºç»™è§‚ä¼— HTTP-FLV)

## è½¯ä»¶æ’­æ”¾

è¿™é‡Œä¸»è¦é’ˆå¯¹mac å¹³å°çš„æ’­æ”¾è½¯ä»¶ï¼š

1. VLC Media Player

2. Live Stream Player

æä¾›ä¸¤ä¸ªå¯ä»¥æµ‹è¯•çš„ rtmp æµåœ°å€

rtmp://liteavapp.qcloud.com/live/liteavdemoplayerstreamid

rtmp://ns8.indexforce.com/home/mystream

![](https://cdn.jsdelivr.net/gh/jacinli/image-hosting@main/notes/20250426225400055.png)

**ðŸ“¦ ï¼ˆæ ‡å‡†ç›´æ’­ç³»ç»Ÿï¼‰ï¼š**

```python
ä¸»æ’­ â†’ RTMP æŽ¨æµ â†’ ç›´æ’­æœåŠ¡å™¨ï¼ˆæ¯”å¦‚ SRSï¼‰ 
    â†’ è½¬ç  + åˆ†å‘ â†’ 
       â†’ HTTP-FLV/HLSï¼ˆè§‚ä¼—æ‹‰æµï¼Œå•å‘ï¼‰
       â†’ WebSocketï¼ˆè§‚ä¼—äº’åŠ¨æ¶ˆæ¯ï¼ŒåŒå‘ï¼‰
       â†’ WebRTCï¼ˆè¿žéº¦ï¼ŒåŒå‘éŸ³è§†é¢‘ï¼‰
```

# æµç¨‹é“¾è·¯

## **1. ðŸ”¥ å»ºç«‹ TCP è¿žæŽ¥**

é¦–å…ˆï¼Œ**RTMP æ˜¯åŸºäºŽ TCP çš„**ï¼Œæ‰€ä»¥ï¼š

- å®¢æˆ·ç«¯ï¼ˆæ¯”å¦‚ OBSã€æŽ¨æµSDKï¼‰é€šè¿‡ TCP è¿žæŽ¥åˆ° RTMP æœåŠ¡å™¨ï¼ˆæ¯”å¦‚ SRSã€Nginx-RTMPã€Wowzaï¼‰ã€‚
- é»˜è®¤ç«¯å£æ˜¯ **1935**ï¼ˆå¯ä»¥æ”¹æˆ443/80ç©¿é€ï¼‰ã€‚

```python
Client â†’ TCPä¸‰æ¬¡æ¡æ‰‹ â†’ Server
```

## **2. ðŸ”¥ RTMP æ¡æ‰‹ï¼ˆHandshakeï¼‰**

RTMPçš„æ¡æ‰‹åˆ†æˆ3æ­¥ï¼ˆC0ã€C1ã€C2 + S0ã€S1ã€S2ï¼‰ï¼š

| **é˜¶æ®µ** | **æè¿°** |
| --- | --- |
| C0 + C1 | å®¢æˆ·ç«¯å‘é€ 1 å­—èŠ‚ç‰ˆæœ¬å·ï¼ˆC0ï¼‰ + 1536å­—èŠ‚éšæœºæ•°æ®ï¼ˆC1ï¼‰ |
| S0 + S1 + S2 | æœåŠ¡å™¨è¿”å›ž 1å­—èŠ‚ç‰ˆæœ¬å·ï¼ˆS0ï¼‰+1536å­—èŠ‚éšæœºæ•°æ®ï¼ˆS1ï¼‰ï¼Œå†è¿”å›žä¸€ä»½ç¡®è®¤ï¼ˆS2ï¼‰ |
| C2 | å®¢æˆ·ç«¯æœ€åŽå‘é€ä¸€ä»½ç¡®è®¤ |
|  |  |

## **3. ðŸ”¥ è¿žæŽ¥è¯·æ±‚ï¼ˆConnectï¼‰**

æ¡æ‰‹æˆåŠŸåŽï¼Œ**å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª connect å‘½ä»¤**ï¼Œå‘Šè¯‰æœåŠ¡å™¨ï¼š

- æˆ‘è¦è¿žå“ªä¸ªåº”ç”¨ï¼ˆappï¼Œæ¯”å¦‚ /liveï¼‰
- ä½¿ç”¨ä»€ä¹ˆæµï¼ˆstream keyï¼Œæ¯”å¦‚ /live/stream123ï¼‰
- åŒ…å«äº†å¾ˆå¤šä¿¡æ¯ï¼ˆç‰ˆæœ¬å·ã€URLã€è®¤è¯tokenã€ç¼–ç æ ¼å¼è¦æ±‚ç­‰ç­‰ï¼‰

æœåŠ¡å™¨æ”¶åˆ° connect è¯·æ±‚åŽï¼Œå›žå¤ä¸€ä¸ª _result æˆ– _errorã€‚

## **4. ðŸ”¥ å»ºç«‹æµï¼ˆCreateStreamï¼‰**

- å®¢æˆ·ç«¯å†å‘ createStream è¯·æ±‚ï¼ˆå¯ä»¥ç†è§£æˆ â€œæˆ‘è¦æ‰“å¼€ä¸€ä¸ªæ’­æ”¾æˆ–æŽ¨æµé€šé“â€ï¼‰
- æœåŠ¡å™¨è¿”å›žä¸€ä¸ª stream_id
- è¿™ä¸ª stream_id åŽç»­ç”¨æ¥æ ‡è¯†å½“å‰çš„åª’ä½“æµã€‚

## **5. ðŸ”¥ æŽ¨æµæˆ–æ‹‰æµï¼ˆPublish / Playï¼‰**

| **ç±»åž‹** | **åŠ¨ä½œ** |
| --- | --- |
| æŽ¨æµï¼ˆä¸»æ’­ï¼‰ | å‘é€ publish å‘½ä»¤ï¼ˆå‡†å¤‡å¾€æœåŠ¡å™¨æŽ¨é€éŸ³è§†é¢‘ï¼‰ |
| æ‹‰æµï¼ˆè§‚ä¼—ï¼‰ | å‘é€ play å‘½ä»¤ï¼ˆå‡†å¤‡ä»ŽæœåŠ¡å™¨æ‹‰å–éŸ³è§†é¢‘ï¼‰ |

## **6. ðŸ”¥ éŸ³è§†é¢‘æ•°æ®ä¼ è¾“**

**è¿™éƒ¨åˆ†å°±æ˜¯ä¸åœå‘ RTMP Messageï¼š**

- éŸ³é¢‘å¸§ï¼ˆAudio Messageï¼‰
- è§†é¢‘å¸§ï¼ˆVideo Messageï¼‰
- å…ƒæ•°æ®ï¼ˆMetadata Messageï¼Œæ¯”å¦‚å®½é«˜fpså˜åŒ–ï¼‰

æ¯ä¸ªæ¶ˆæ¯æœ‰è‡ªå·±çš„ header å’Œ payloadï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´åŸºäºŽ TCP ä¿æŒé€šä¿¡

# **ðŸ“¦ è¿žæŽ¥å’Œé‡Šæ”¾çš„å…³ç³»**

**ðŸ”¥ è¿žæŽ¥å»ºç«‹æµç¨‹ï¼ˆConnection Setupï¼‰**

```python
TCPè¿žæŽ¥ â†’ RTMPæ¡æ‰‹ â†’ connectå‘½ä»¤ â†’ createStream â†’ publishæˆ–play â†’ æŽ¨æµæˆ–æ‹‰æµ
```

**æ•´ä¸ªè¿žæŽ¥ç”Ÿå‘½å‘¨æœŸæ˜¯ç»‘å®šçš„ï¼**

- åªè¦ TCP è¿žæŽ¥å­˜åœ¨ï¼ŒRTMPçš„ session å°±å­˜åœ¨ã€‚
- æµï¼ˆstreamï¼‰æ˜¯åŸºäºŽè¿žæŽ¥ä¹‹ä¸Šçš„ä¸€ä¸ªèµ„æºï¼ˆstream_idæ ‡è¯†ï¼‰ã€‚

## **ðŸ”¥ è¿žæŽ¥é‡Šæ”¾æµç¨‹ï¼ˆConnection Teardownï¼‰**

| **åœºæ™¯** | **è§¦å‘æ¡ä»¶** |
| --- | --- |
| æ­£å¸¸æ–­å¼€ | å®¢æˆ·ç«¯å‘é€ deleteStream å‘½ä»¤ï¼Œå‘Šè¯‰æœåŠ¡å™¨æˆ‘è¦å…³é—­æµï¼›ç„¶åŽå‘é€ close å‘½ä»¤æ–­å¼€è¿žæŽ¥ï¼›æœ€åŽ TCP å››æ¬¡æŒ¥æ‰‹ |
| å¼‚å¸¸æ–­å¼€ | å®¢æˆ·ç«¯æ–­ç”µã€å´©æºƒã€ç½‘ç»œå¼‚å¸¸ï¼ŒTCPè¿žæŽ¥ç›´æŽ¥æ–­æŽ‰ |
| æœåŠ¡å™¨è¸¢å‡º | å¦‚æžœæœåŠ¡å™¨æ£€æµ‹åˆ°éžæ³•æµã€é•¿æ—¶é—´ç©ºé—²ã€è®¤è¯å¤±è´¥ï¼Œä¼šå¼ºåˆ¶å…³é—­ TCP è¿žæŽ¥ |
| è¶…æ—¶æ–­å¼€ | æœ‰äº›æœåŠ¡å™¨è®¾ç½® idle timeoutï¼Œæ¯”å¦‚ 60ç§’æ— æ•°æ®ï¼Œè‡ªåŠ¨è¸¢æŽ‰ |

ä¸€æ—¦ TCP æ–­å¼€ï¼ŒRTMP session å’Œæ‰€æœ‰ç›¸å…³ stream éƒ½è¢«æ¸…ç†ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

```python
[Client]             [Server]
    |    TCP connect     |
    |------------------->|
    |    RTMP handshake   |
    |<------------------->|
    |    connect          |
    |------------------->|
    |    _result          |
    |<-------------------|
    |    createStream     |
    |------------------->|
    |    _result(streamId)|
    |<-------------------|
    |    publish/play     |
    |------------------->|
    |    start streaming  |
    |<===================>|
    |    deleteStream     |
    |------------------->|
    |    close connection |
    |------------------->|
    |  (TCP close)        |
```