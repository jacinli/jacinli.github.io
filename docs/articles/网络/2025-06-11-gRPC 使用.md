# ç›®å½•

[[toc]]

## .proto æ–‡ä»¶

**.proto æ–‡ä»¶** æ˜¯ **gRPC å’Œ Protocol Buffers çš„æ¥å£å®šä¹‰æ–‡ä»¶**ï¼Œå®ƒæè¿°äº†ï¼š

1. è¦ä¼ é€’ä»€ä¹ˆæ•°æ®ï¼ˆä¹Ÿå°±æ˜¯**æ¶ˆæ¯ä½“** messageï¼‰ã€‚
2. è¦æš´éœ²ä»€ä¹ˆæ¥å£ï¼ˆä¹Ÿå°±æ˜¯**æœåŠ¡** service å’Œå®ƒä»¬çš„ **æ–¹æ³•**ï¼‰ã€‚

ä¹Ÿå°±æ˜¯**ä¸€ä»½è§„èŒƒæ–‡ä»¶**ï¼Œè®©å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯èƒ½æŒ‰ç…§ç›¸åŒçš„çº¦å®šç›¸äº’é€šä¿¡ã€‚

my_service.proto

```jsx
syntax = "proto3";  // æŒ‡å®šä½¿ç”¨ proto3 è¯­æ³•ç‰ˆæœ¬

package demo;       // åŒ…åï¼Œæ–¹ä¾¿ç”Ÿæˆä»£ç æ—¶åˆ†æ¨¡å—

service MyService {
  // å®šä¹‰ RPC æœåŠ¡
  rpc Predict(PredictRequest) returns (PredictResponse) {}
}

message PredictRequest {
  string prompt = 1;
}

message PredictResponse {
  string result = 1;
}
```

1. **ç”¨ protoc è‡ªåŠ¨ç”Ÿæˆå®¢æˆ·ç«¯/æœåŠ¡ç«¯ä»£ç **
è¿™é‡Œä½¿ç”¨ python æ¥è¿›è¡Œæ“ä½œ

```jsx
python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. my_service.proto

```

- I. æŒ‡å®š proto æœç´¢è·¯å¾„ä¸ºå½“å‰ç›®å½•
- -python_out=. ç”Ÿæˆ my_service_pb2.pyï¼ˆå®šä¹‰æ¶ˆæ¯ç±»å‹ï¼‰
- -grpc_python_out=. ç”Ÿæˆ my_service_pb2_grpc.pyï¼ˆå®šä¹‰æœåŠ¡ç±»æ¥å£ï¼‰

å› ä¸º gRPC è¦è·¨è¯­è¨€ï¼Œæ‰€ä»¥å¿…é¡»æœ‰**è¯­è¨€æ— å…³çš„æè¿°æ–‡ä»¶**ï¼š

- .proto å°±æ˜¯ç»Ÿä¸€è§„èŒƒ
- Protocol Buffers å®šä¹‰æ•°æ®ä¼ è¾“ç»“æ„ï¼ˆæ¯” JSON è½»é‡ã€é«˜é€Ÿã€å¼ºç±»å‹ï¼‰
- gRPC æ¡†æ¶ç”¨å®ƒç”Ÿæˆå®¢æˆ·ç«¯/æœåŠ¡ç«¯ã€è‡ªåŠ¨åºåˆ—åŒ–ã€è‡ªåŠ¨ç½‘ç»œä¼ è¾“

- protoc ä¼šä»¥è¾“å…¥æ–‡ä»¶ my_service.proto çš„**æ–‡ä»¶å**ä¸ºåŸºå‡†è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ Python æ–‡ä»¶ã€‚
- å®ƒæ²¡æœ‰å•ç‹¬çš„å‚æ•°å»è‡ªå®šä¹‰ç”Ÿæˆæ–‡ä»¶åï¼Œæ‰€ä»¥é»˜è®¤å°±æ˜¯ï¼š
    
    âœ… my_service_pb2.pyï¼š
    
    - åŒ…å«ä½  .proto ä¸­**å®šä¹‰çš„ message å’Œ enum ç±»å‹**å¯¹åº”çš„ Python ç±»ã€‚
    
    âœ… my_service_pb2_grpc.pyï¼š
    
    - åŒ…å«ä½  .proto ä¸­**å®šä¹‰çš„ service å’Œ RPC æ–¹æ³•**å¯¹åº”çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ¡©ä»£ç ã€‚

```jsx
<protoæ–‡ä»¶å>_pb2.py
<protoæ–‡ä»¶å>_pb2_grpc.py
```

| **æ–‡ä»¶** | **åŒ…å«å†…å®¹** | **ç”¨é€”** |
| --- | --- | --- |
| my_service_pb2.py | æ¶ˆæ¯ç±»å‹ç±»ï¼ˆmessageã€enumï¼‰ | åºåˆ—åŒ–/ååºåˆ—åŒ–æ•°æ® |
| my_service_pb2_grpc.py | æœåŠ¡ç±»å’Œå®¢æˆ·ç«¯/æœåŠ¡ç«¯æ¥å£ | å®ç°æœåŠ¡é€»è¾‘/è°ƒç”¨è¿œç¨‹æœåŠ¡ |

- pb2.py â†’ è´Ÿè´£**æ•°æ®æ¨¡å‹**
- pb2_grpc.py â†’ è´Ÿè´£**æœåŠ¡è°ƒç”¨é€»è¾‘ï¼ˆRPC æ¥å£ï¼‰**

## æœåŠ¡ç«¯å®ç°

```jsx
from concurrent import futures
import grpc
import my_service_pb2
import my_service_pb2_grpc

# å®ç° RPC æœåŠ¡
class MyService(my_service_pb2_grpc.MyServiceServicer):
# æ˜¯ç”Ÿæˆçš„æœåŠ¡ç«¯åŸºç±»ï¼Œè¿™é‡Œæˆ‘ä»¬ç»§æ‰¿å®ƒå¹¶å®ç° Predict æ–¹æ³•é€»è¾‘ã€‚
    def Predict(self, request, context):
        print(f"Received prompt: {request.prompt}")
        return my_service_pb2.PredictResponse(result=f"Hello, {request.prompt}!")

# å¯åŠ¨ gRPC æœåŠ¡å™¨
def serve():
    server = grpc.server(futures.ThreadPoolExecutor(max_workers=10))
    my_service_pb2_grpc.add_MyServiceServicer_to_server(MyService(), server)
    server.add_insecure_port("[::]:50051")
    server.start()
    print("gRPC Server running at 0.0.0.0:50051...")
    server.wait_for_termination()

if __name__ == "__main__":
    serve()
    #  python -m grpc_tools.protoc -I. --pytheon_out=. --grpc_python_out=. my_service.proto
```

âœ… grpc.server(...) åˆ›å»º gRPC æœåŠ¡å™¨å®ä¾‹ï¼Œå¹¶ç»™å®ƒåˆ†é…ä¸€ä¸ª**çº¿ç¨‹æ± **ï¼ˆèƒ½åŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚ï¼‰ã€‚

âœ… add_MyServiceServicer_to_server(MyService(), server) æ³¨å†Œæˆ‘ä»¬è‡ªå·±å®ç°çš„æœåŠ¡é€»è¾‘ã€‚

âœ… server.add_insecure_port("[::]:50051") æ‰“å¼€ç›‘å¬ç«¯å£ã€‚

âœ… server.start() å¯åŠ¨æœåŠ¡ï¼Œwait_for_termination() è®©æœåŠ¡æŒç»­ç›‘å¬ï¼Œä¸ä¼šè‡ªåŠ¨ç»“æŸã€‚

`_builder.BuildTopDescriptorsAndMessages(DESCRIPTOR, 'my_service_pb2', _globals)`

- åŠ¨æ€**æ³¨å†Œç”Ÿæˆæ¶ˆæ¯ç±»**ã€‚

ä¹Ÿå°±æ˜¯ï¼š

- PredictRequestã€PredictResponse è¿™äº›ç±»**åœ¨å¯¼å…¥æ—¶åŠ¨æ€åˆ›å»º**ï¼ŒIDE é™æ€åˆ†æå™¨ï¼ˆæ¯”å¦‚ PyCharmï¼‰æ— æ³•æå‰çŸ¥é“å®ƒä»¬å­˜åœ¨ï¼Œå› æ­¤ä½ ç”¨ IDE æŸ¥çœ‹æ—¶æ‰¾ä¸åˆ°å®šä¹‰ã€‚
- ä½†æ˜¯ç¨‹åºè¿è¡Œæ—¶ï¼Œè¿™äº›ç±»**ä¼šå­˜åœ¨**ï¼Œå¹¶èƒ½æ­£å¸¸ä½¿ç”¨ã€‚

```jsx
DESCRIPTOR = _descriptor_pool.Default().AddSerializedFile(b'\n\x10my_service.proto\x12\x04\x64\x65mo\" \n\x0ePredictRequest\x12\x0e\n\x06prompt\x18\x01 \x01(\t\"!\n\x0fPredictResponse\x12\x0e\n\x06result\x18\x01 \x01(\t2E\n\tMyService\x12\x38\n\x07Predict\x12\x14.demo.PredictRequest\x1a\x15.demo.PredictResponse\"\x00\x62\x06proto3')

```

- AddSerializedFile(...) æŠŠä½  .proto å®šä¹‰ç¼–è¯‘æˆçš„**äºŒè¿›åˆ¶æè¿°æ•°æ®**æ³¨å†Œè¿› DescriptorPoolã€‚
- ä¹Ÿå°±æ˜¯æŠŠæ•´ä¸ª my_service.proto çš„ç»“æ„ä¿¡æ¯ï¼ˆæœåŠ¡ã€æ¶ˆæ¯ç±»å‹ã€å­—æ®µç­‰ï¼‰å¡å…¥ä¸€ä¸ª**æè¿°æ± **ä¸­ã€‚

## å®¢æˆ·ç«¯å®ç°

```jsx
import grpc
import my_service_pb2
import my_service_pb2_grpc

def run_client():
    channel = grpc.insecure_channel("localhost:50051")
    stub = my_service_pb2_grpc.MyServiceStub(channel)
    response = stub.Predict(my_service_pb2.PredictRequest(prompt="World111"))
    print(f"Server response: {response.result}")

if __name__ == "__main__":
    run_client()
```

å®¢æˆ·ç«¯ä¸»è¦åšä¸‰ä»¶äº‹ï¼š

1. å»ºç«‹ gRPC è¿æ¥ï¼ˆchannelï¼‰ã€‚
2. ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ stub æ¥è°ƒç”¨æœåŠ¡ç«¯æ–¹æ³•ã€‚
3. æ¥æ”¶æœåŠ¡ç«¯è¿”å›çš„å“åº”å¹¶æ‰“å°ã€‚

| **ä»£ç éƒ¨åˆ†** | **è§£é‡Š** |
| --- | --- |
| grpc.insecure_channel() | ä½¿ç”¨**æœªåŠ å¯†**é€šé“ï¼ˆé€‚åˆæœ¬åœ°æµ‹è¯•ï¼Œä¸æ¨èç”Ÿäº§ç¯å¢ƒç›´æ¥ç”¨è¿™ä¸ªï¼Œè¦ç”¨ TLS ç‰ˆ secure_channel()ï¼‰ |
| MyServiceStub(channel) | è¿™æ˜¯ gRPC è‡ªåŠ¨ç”Ÿæˆçš„**å®¢æˆ·ç«¯ç±»**ï¼Œå†…éƒ¨å·²ç»å¸®ä½ å®ç°å¥½äº† RPC åºåˆ—åŒ–ã€ååºåˆ—åŒ–é€»è¾‘ |
| PredictRequest() | ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ç±»æ„é€  RPC è¯·æ±‚å¯¹è±¡ï¼Œè¿™ä¸ªç±»å¯¹åº”ä½ çš„ proto ä¸­å®šä¹‰çš„æ¶ˆæ¯ç±»å‹ |
| stub.Predict(...) | ç›¸å½“äºè¿œç¨‹è°ƒç”¨æœåŠ¡ç«¯çš„ Predict()ï¼ŒgRPC ä¼šè‡ªåŠ¨åºåˆ—åŒ–è¯·æ±‚ã€ç½‘ç»œä¼ è¾“ã€ååºåˆ—åŒ–å“åº” |
| response.result | æœåŠ¡ç«¯è¿”å›çš„ PredictResponse æ¶ˆæ¯å¯¹è±¡ï¼Œå–å®ƒçš„ result å­—æ®µå°±æ˜¯ä½ æœåŠ¡è¿”å›çš„å†…å®¹ |

### **ğŸš€ å®¢æˆ·ç«¯ vs æœåŠ¡ç«¯å¯¹åº”å…³ç³»**

æœåŠ¡ç«¯ï¼š

```jsx
class MyService(my_service_pb2_grpc.MyServiceServicer):
    def Predict(self, request, context):
        return my_service_pb2.PredictResponse(result=f"Hello, {request.prompt}!")
```

å®¢æˆ·ç«¯ï¼š

```jsx
response = stub.Predict(
    my_service_pb2.PredictRequest(prompt="World111")
)
```

å®¢æˆ·ç«¯è°ƒç”¨ Predict() æ—¶ï¼š

- åº•å±‚å¸®ä½ åºåˆ—åŒ– prompt å‚æ•°å¹¶ä¼ ç»™æœåŠ¡ç«¯
- æœåŠ¡ç«¯æ‰§è¡Œå¯¹åº”é€»è¾‘å¹¶è¿”å› result ç»™å®¢æˆ·ç«¯
- å®¢æˆ·ç«¯æ‹¿åˆ°ç»“æœæ‰“å°å‡ºæ¥ ğŸ‰

ä¹Ÿå¯ä»¥ä½¿ç”¨ go æ¥å®¢æˆ·ç«¯ï¼Œæ³¨æ„å…ˆ

```jsx
protoc --go_out=. --go-grpc_out=. my_service.proto
```

go

```jsx
package main

import (
    "context"
    "log"
    "time"

    "google.golang.org/grpc"
    pb "path/to/generated/my_service" // å¼•å…¥ç”Ÿæˆçš„åŒ…
)

func main() {
    // 1ï¸âƒ£ å»ºç«‹ gRPC è¿æ¥
    conn, err := grpc.Dial("localhost:50051", grpc.WithInsecure()) 
    if err != nil {
        log.Fatalf("è¿æ¥å¤±è´¥: %v", err)
    }
    defer conn.Close()

    // 2ï¸âƒ£ åˆ›å»ºå®¢æˆ·ç«¯å­˜æ ¹
    client := pb.NewMyServiceClient(conn)

    // 3ï¸âƒ£ è°ƒç”¨æœåŠ¡
    ctx, cancel := context.WithTimeout(context.Background(), time.Second*5)
    defer cancel()
    resp, err := client.Predict(ctx, &pb.PredictRequest{Prompt: "Hello Go!"})
    if err != nil {
        log.Fatalf("è°ƒç”¨é”™è¯¯: %v", err)
    }

    log.Printf("æœåŠ¡è¿”å›: %s\n", resp.Result)
}
```

## æ€»ç»“

æ— è®ºæ˜¯ **gRPC**ã€è…¾è®¯çš„ **tRPC**ï¼Œç”šè‡³å›½å†…å¾ˆå¤š RPC æ¡†æ¶ï¼ˆä¾‹å¦‚é˜¿é‡Œ HSFã€èš‚èš SOFA RPCï¼‰ï¼Œå®ƒä»¬èƒŒåçš„**å®ç°æ€è·¯éƒ½æ˜¯ä¸€æ ·çš„**ğŸ‘‡ï¼š

**ğŸ”„å…±åŒç‚¹ï¼š**

1. **å…ˆå®šä¹‰æ¥å£åè®®ï¼ˆIDLï¼‰**
    
    ç”¨ protoã€.thriftã€.proto3 æˆ–è€…ç±»ä¼¼ IDL æ–‡ä»¶æè¿°ä½ çš„æœåŠ¡ã€æ–¹æ³•ã€æ¶ˆæ¯ã€‚
    
2. **ä»£ç ç”Ÿæˆå™¨ç”Ÿæˆå¯¹åº”è¯­è¨€çš„å®¢æˆ·ç«¯/æœåŠ¡ç«¯å­˜æ ¹**
    
    protocã€trpcproto æˆ–è€…å¯¹åº”è¯­è¨€æ’ä»¶ â†’ è‡ªåŠ¨ç”Ÿæˆï¼š
    
    - æœåŠ¡æ¥å£ç±»ï¼ˆStub / Service æ¥å£ï¼‰
    - æ¶ˆæ¯ç±»ï¼ˆåºåˆ—åŒ– / ååºåˆ—åŒ–é€»è¾‘ï¼‰
3. **æœåŠ¡ç«¯å®ç° Service ç±»é€»è¾‘**
    
    ä½ åªéœ€ç»§æ‰¿ç”Ÿæˆçš„æœåŠ¡æ¥å£ï¼Œç„¶åå®ç°æ–¹æ³•é€»è¾‘å³å¯ã€‚
    
4. **å®¢æˆ·ç«¯ç”¨ç”Ÿæˆçš„å­˜æ ¹è°ƒç”¨æ–¹æ³•**
    
    å°±åƒè°ƒç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·ï¼Œä¸éœ€è¦æ‰‹åŠ¨æ‹¼æ¥ç½‘ç»œæ•°æ®ã€åºåˆ—åŒ–äºŒè¿›åˆ¶æµã€‚
    

```jsx
.proto æ–‡ä»¶
    â†“
[ç”Ÿæˆå·¥å…·] è‡ªåŠ¨ç”Ÿæˆä»£ç 
    â†“
æœåŠ¡ç«¯: å®ç° Service ç±»
å®¢æˆ·ç«¯: ä½¿ç”¨ Client Stub è°ƒç”¨
    â†“
åº•å±‚è´Ÿè´£ç½‘ç»œä¼ è¾“ã€åºåˆ—åŒ–ã€è´Ÿè½½å‡è¡¡ã€é”™è¯¯å¤„ç†...
```

âœ… **å‡å°‘é‡å¤ä»£ç ** â€” ä¸ç”¨ä½ æ‰‹å†™ç½‘ç»œåºåˆ—åŒ–éƒ¨åˆ†

âœ… **å¼ºç±»å‹æ£€æŸ¥** â€” è°ƒç”¨æ–¹/æœåŠ¡æ–¹éƒ½èƒ½çŸ¥é“æ•°æ®ç»“æ„

âœ… **æ–¹ä¾¿è·¨è¯­è¨€è°ƒç”¨** â€” ä¸€ä»½åè®®ï¼Œä¸åŒè¯­è¨€éƒ½èƒ½ç”Ÿæˆå¯¹åº”å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯

âœ… **å‡å°‘ç½‘ç»œç»†èŠ‚å…³æ³¨** â€” æŠŠç½‘ç»œéƒ¨åˆ†å°è£…èµ·æ¥