# ç›®å½•

[[toc]]

## å·¥å…·

**âœ… ä¸€ç«™å¼æ¨èæ–¹æ¡ˆï¼ˆè½»é‡ + å¿«é€Ÿï¼‰**

| **å·¥å…·** | **ä½œç”¨** | **æ˜¯å¦å¿…é¡»** |
| --- | --- | --- |
| ruff | æ ¼å¼åŒ– + lint + isort ä¸€ä½“åŒ– | âœ… å¿…é¡» |
| mypy | é™æ€ç±»å‹æ£€æŸ¥ï¼Œé€‚é… SQLAlchemy 2.0 | âœ… æ¨è |
| pytest + pytest-cov | æµ‹è¯• + è¦†ç›–ç‡ | âœ… æ¨è |
| bandit | å®‰å…¨å®¡æŸ¥ | å¯é€‰ |
| pre-commit | æœ¬åœ°æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ | âœ… å¼ºçƒˆæ¨è |

## ç›¸å…³æ­¥éª¤

**ğŸ§° æ­¥éª¤ä¸€ï¼šç”¨ uv å®‰è£…ä¾èµ–**

```python
uv pip install -U ruff mypy pytest pytest-cov bandit pre-commit
```

**ğŸ§¼ æ­¥éª¤äºŒï¼šä½¿ç”¨ Ruff è¿›è¡Œæ ¼å¼åŒ– + Lintï¼ˆæ ¸å¿ƒï¼‰**

**âœ… åˆ›å»º pyproject.toml é…ç½®æ–‡ä»¶ï¼ˆRuff + Mypy ä¸€èµ·æ”¾ï¼‰**

```python
# pyproject.toml
[tool.ruff]
line-length = 100
extend-select = ["I"]  # è‡ªåŠ¨ import æ’åºï¼ˆisortï¼‰
fix = true             # è‡ªåŠ¨ä¿®å¤

[tool.mypy]
plugins = ["sqlalchemy.ext.mypy.plugin"]
ignore_missing_imports = true
strict_optional = true
disallow_untyped_defs = true
check_untyped_defs = true
warn_unused_ignores = true
```

**âœ… æ‰§è¡Œ Ruff æ ¼å¼åŒ–å’Œæ£€æŸ¥ï¼š**

```python
# æ ¼å¼åŒ–ï¼ˆç›¸å½“äº black + isortï¼‰
ruff format .

# æ£€æŸ¥ä»£ç è§„èŒƒï¼ˆç›¸å½“äº flake8ï¼‰
ruff check .
```

**ğŸ§ª æ­¥éª¤ä¸‰ï¼šç±»å‹æ£€æŸ¥ï¼ˆå°¤å…¶é€‚é… SQLAlchemy 2.0ï¼‰**

```python
mypy app/  # å‡è®¾ä½ çš„ä»£ç æ”¾åœ¨ app/ ç›®å½•
```

**ğŸ§¹ æ­¥éª¤å››ï¼šé…ç½® pre-commitï¼ˆè‡ªåŠ¨æ£€æŸ¥ï¼‰**

```python
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.3.3
    hooks:
      - id: ruff
      - id: ruff-format

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy

  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.4
    hooks:
      - id: bandit
```

**âœ… å®‰è£…å¹¶æ¿€æ´»**

pre-commit install

**ğŸ§° æ­¥éª¤äº”ï¼ˆå¯é€‰ï¼‰ï¼šCI è‡ªåŠ¨æ£€æŸ¥ï¼ˆGitHub Actionsï¼‰**

```python
# .github/workflows/code-quality.yml
name: Code Quality

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          pip install ruff mypy bandit
      - name: Ruff Check
        run: ruff check .
      - name: Mypy Check
        run: mypy app/
      - name: Bandit Check
        run: bandit -r app/
```

| **ä»»åŠ¡** | **å‘½ä»¤** |
| --- | --- |
| æ ¼å¼åŒ–ä»£ç  | ruff format . |
| æ£€æŸ¥ä»£ç è§„èŒƒ | ruff check . |
| ç±»å‹æ£€æŸ¥ | mypy app/ |
| å®‰å…¨æ£€æŸ¥ | bandit -r app/ |
| å¯ç”¨ git æäº¤æ£€æŸ¥ | pre-commit install |
| ä¸€é”®æ¸…æ´— | pre-commit run --all-files |

## Makefile æ¨¡æ¿

**âœ… æ¨è Makefile æ¨¡æ¿ï¼ˆFastAPI + SQLAlchemy + Ruff + Mypy ä¸“ç”¨ï¼‰**

```python
# Makefile for FastAPI code style and quality

# æ ¼å¼åŒ–ä»£ç ï¼ˆruff formatï¼‰
format:
	ruff format .

# Lint æ£€æŸ¥ï¼ˆruff checkï¼‰
lint:
	ruff check .

# ç±»å‹æ£€æŸ¥ï¼ˆmypyï¼‰
typecheck:
	mypy app/

# å®‰å…¨æ£€æŸ¥ï¼ˆbanditï¼‰
security:
	bandit -r app/

# ä¸€é”®æ£€æŸ¥æ‰€æœ‰å†…å®¹ï¼ˆæ ¼å¼ã€é£æ ¼ã€ç±»å‹ï¼‰
check: format lint typecheck

# è¿è¡Œæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
test:
	pytest -v --cov=app tests/

# ä¸€é”®æ‰§è¡Œæ‰€æœ‰è´¨é‡æ§åˆ¶
all: check test
```

**âœ… ä½ ç°åœ¨å¯ä»¥ä½¿ç”¨çš„å‘½ä»¤ï¼š**

| **å‘½ä»¤** | **è¯´æ˜** |
| --- | --- |
| make format | è‡ªåŠ¨æ ¼å¼åŒ–æ‰€æœ‰ä»£ç  |
| make lint | ä½¿ç”¨ ruff æ£€æŸ¥ä»£ç è§„èŒƒ |
| make typecheck | ç”¨ mypy åšç±»å‹æ£€æŸ¥ |
| make security | ç”¨ bandit åšå®‰å…¨æ‰«æ |
| make check | æ ¼å¼åŒ– + Lint + ç±»å‹æ£€æŸ¥ ä¸€é”®æ‰§è¡Œ |
| make test | è¿è¡Œæµ‹è¯•ï¼ˆå¯é€‰ï¼‰ |
| make all | æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥ + æµ‹è¯• âœ… |

**âœ… å›ç­”ï¼šåªè¦ä½ æœ‰ Makefile æ–‡ä»¶ï¼Œå¹¶ä¸”ç³»ç»Ÿä¸Šå®‰è£…äº† make å‘½ä»¤ï¼Œå°±å¯ä»¥ç›´æ¥ç”¨ï¼š**

ä½¿ç”¨make å‘½ä»¤

**âœ… ä¸ºä»€ä¹ˆè¦å…ˆ formatï¼Œå† lintï¼Ÿ**

| **é¡ºåº** | **åŸå› ** |
| --- | --- |
| âœ… å…ˆ ruff format | è‡ªåŠ¨ä¿®å¤ç©ºæ ¼ã€ç¼©è¿›ã€import é¡ºåºç­‰æ ¼å¼é—®é¢˜ |
| âœ… å† ruff check | æ‰èƒ½çœ‹åˆ°çœŸæ­£â€œé€»è¾‘/è¯­æ³•å±‚é¢â€çš„ lint é—®é¢˜ |
| âŒ å¦‚æœå…ˆ checkï¼Œå† format | ä¼šå…ˆæŠ¥ä¸€å †æ ¼å¼é”™è¯¯ï¼Œformat åå†è·‘ check æ²¡æ„ä¹‰ï¼ˆé‡å¤è·‘ï¼‰ |

å®‰è£…é’©å­

```python
pre-commit install  # å®‰è£… Git é’©å­
pre-commit run --all-files  # æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶
```