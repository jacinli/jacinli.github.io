# ä»‹ç»

**pytest** æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€çµæ´»ä¸”æ˜“ç”¨çš„ Python æµ‹è¯•æ¡†æ¶ï¼Œç”¨äºç¼–å†™å’Œè¿è¡Œå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ç­‰ã€‚å®ƒæ˜¯ Python ç¤¾åŒºä¸­æœ€å—æ¬¢è¿çš„æµ‹è¯•å·¥å…·ä¹‹ä¸€ï¼Œç›¸æ¯”å†…ç½®çš„ unittest æ¨¡å—ï¼Œpytest æä¾›äº†æ›´ç®€æ´çš„è¯­æ³•ã€æ›´ä¸°å¯Œçš„åŠŸèƒ½å’Œæ›´å¥½çš„æ‰©å±•æ€§ã€‚

- **å®˜ç½‘**: [pytest.org](https://docs.pytest.org/)
- **å®‰è£…**: é€šè¿‡ pip å®‰è£… pip install pytestã€‚
- **ç‰ˆæœ¬è¦æ±‚**: å½“å‰ä½¿ç”¨çš„æ˜¯ pytest-8.3.5ï¼ˆæ ¹æ®ä½ çš„è¾“å‡ºï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªè¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œæ”¯æŒ Python 3.12ã€‚

ä¸éœ€è¦ç»§æ‰¿ç‰¹å®šçš„åŸºç±»ï¼ˆå¦‚ unittest.TestCaseï¼‰ï¼Œåªéœ€å†™æ™®é€šçš„ Python å‡½æ•°ã€‚ä½¿ç”¨ assert è¯­å¥å³å¯è¿›è¡Œæ–­è¨€ï¼Œæ— éœ€å¤æ‚çš„ self.assertEqual ç­‰æ–¹æ³•ã€‚

- ä¸éœ€è¦ç»§æ‰¿ç‰¹å®šçš„åŸºç±»ï¼ˆå¦‚ unittest.TestCaseï¼‰ï¼Œåªéœ€å†™æ™®é€šçš„ Python å‡½æ•°ã€‚
- ä½¿ç”¨ assert è¯­å¥å³å¯è¿›è¡Œæ–­è¨€ï¼Œæ— éœ€å¤æ‚çš„ self.assertEqual ç­‰æ–¹æ³•ã€‚

# é…ç½®

pytest.ini

```python
[pytest]
testpaths = tests
pythonpath = .

# pytest -v
```

åœ¨tests/test_exampel:

```python

import pytest

def test_example():
    assert 1 == 1

```

è¿™å°±æ˜¯æœ€ç®€å•çš„ä¾‹å­äº†

è¿è¡Œï¼š

```python
pytest -v
```

# å¸¸ç”¨çš„å†™æ³•

**ğŸ§© ä¸€ã€æ–­è¨€èƒ½åŠ›ï¼ˆassertï¼‰**

ä½ å¯ä»¥æ–­çš„ä¸åªæ˜¯ ==ï¼Œè€Œæ˜¯ä»»ä½• Python è¡¨è¾¾å¼ï¼š

```python
def test_math():
    assert 1 + 1 == 2
    assert "hello".upper() == "HELLO"
    assert isinstance(3.14, float)
    assert 5 in [1, 2, 3, 4, 5]
```

**ğŸ§ª äºŒã€å‚æ•°åŒ–æµ‹è¯•ï¼ˆparametrizeï¼‰**

```python
import pytest

@pytest.mark.parametrize("a,b,expected", [
    (1, 2, 3),
    (2, 2, 4),
    (3, 5, 8)
])
def test_add(a, b, expected):
    assert a + b == expected
```

**ğŸ”§ ä¸‰ã€ä½¿ç”¨ fixture ç®¡ç†é‡å¤é€»è¾‘ï¼ˆæ•°æ®å‡†å¤‡/æ¸…ç†ï¼‰**

user_data() åªå†™ä¸€éï¼Œå¤šä¸ªæµ‹è¯•ç”¨ï¼Œ**è‡ªåŠ¨æ³¨å…¥**ã€‚

```python
@pytest.fixture
def user_data():
    return {"name": "Alice", "age": 30}

def test_user_name(user_data):
    assert user_data["name"] == "Alice"

def test_user_age(user_data):
    assert user_data["age"] == 30
```

**ğŸ§° å››ã€æ•æ‰å¼‚å¸¸**

```python
def divide(a, b):
    return a / b

def test_divide_by_zero():
    with pytest.raises(ZeroDivisionError):
        divide(1, 0)
```

**ğŸ•¹ï¸ äº”ã€åˆ†ç»„æµ‹è¯•ï¼ˆclass æµ‹è¯•ç»„ç»‡ï¼‰** 

```python
class TestMath:
    def test_add(self):
        assert 1 + 1 == 2

    def test_mul(self):
        assert 2 * 3 == 6
```

ä½ å¯ä»¥è¿è¡Œç‰¹å®šç±»çš„æµ‹è¯•ï¼š

```python

pytest tests/test_example.py::TestMath

è¿è¡Œå•ä¸ªæ–¹æ³•ï¼š
pytest tests/test_example.py::TestMath::test_add
```

**ğŸ§¼ å…­ã€è¿è¡Œé¡ºåºå’Œ setup/teardown**

```python
@pytest.fixture
def setup_and_teardown():
    print("\nsetup")
    yield
    print("teardown")

def test_abc(setup_and_teardown):
    print("running test")
    assert True
```

**ğŸ ä¸ƒã€ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°å’Œè°ƒè¯•æŠ€å·§**

```
â€¢	-vï¼šæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
â€¢	-xï¼šé‡åˆ°å¤±è´¥å°±åœæ­¢
â€¢	-k "å…³é”®å­—"ï¼šåªè¿è¡ŒåŒ…å«å…³é”®å­—çš„æµ‹è¯•
â€¢	--maxfail=2ï¼šæœ€å¤šå¤±è´¥ä¸¤ä¸ªå°±åœ

```

**âœ… æ€»ç»“æ ¼å¼**

```python
pytest <æ–‡ä»¶è·¯å¾„>::<ç±»å>::<æ–¹æ³•å>
```

# æµ‹è¯•FastAPI è·¯ç”±

é…åˆ FastAPI æä¾›çš„ TestClientï¼ˆåŒæ­¥æµ‹è¯•ï¼‰æˆ– AsyncClientï¼ˆå¼‚æ­¥æµ‹è¯•ï¼‰ï¼Œä½ å¯ä»¥è½»æ¾å†™å‡ºåƒè¿™æ ·æµ‹è¯• API çš„ä»£ç ï¼š

## åŒæ­¥æµ‹è¯•

```python
@app.get("/ping")
def ping():
    return {"msg": "pong"}
```

æµ‹è¯•ä»£ç ï¼š

```python
from fastapi.testclient import TestClient
from routers.sse_router import app

client = TestClient(app)

def test_ping():
    response = client.get("/ping")
    assert response.status_code == 200
    assert response.json() == {"msg": "pong"}
```

## å¼‚æ­¥æµ‹è¯•

ä½¿ç”¨å¼‚æ­¥æ’ä»¶ï¼š

```python
pip install pytest-asyncio
```

åœ¨pytest.iniæ·»åŠ ï¼š

```python
# pytest.ini
[pytest]
asyncio_mode = auto
```

è¿˜éœ€è¦ï¼š

```python
pip install "httpx[http2]==0.27.0"
```

**ğŸ” ä¸ºä»€ä¹ˆéœ€è¦ [http2]ï¼Ÿ**

```python
AsyncClient(app=...) è¿™ä¸ªåŠŸèƒ½ä¾èµ–äº† h11, h2, anyio, httpcore, asgiref ç­‰ ASGI æ”¯æŒç»„ä»¶ã€‚

httpx çš„ extra å®‰è£…é¡¹ [http2] ä¼šè‡ªåŠ¨æŠŠå®ƒä»¬éƒ½è£…ä¸Šã€‚
```

| **é—®é¢˜** | **åŸå› ** | **è§£å†³æ–¹å¼** |
| --- | --- | --- |
| 502 Bad Gateway | httpx.app=app æ–¹å¼ä¸å†å¯é  | âœ… æ”¹ç”¨ transport=ASGITransport(app=...) |
| DeprecationWarning | app= å‚æ•°å·²å¼ƒç”¨ | âœ… åŒä¸Š |
| è·¯ç”±æœªæ³¨å†Œ/æœªå¯åŠ¨ | startup æœªè¢«è§¦å‘ | âœ… ä½¿ç”¨ ASGITransport èƒ½æ¨¡æ‹Ÿå®Œæ•´ç”Ÿå‘½å‘¨æœŸ |

æµ‹è¯•ä»£ç ï¼š

```python
@app.get("/hello")
async def hello():
    return {"message": "Hello async!"}
```

æµ‹è¯•ï¼š

```python
@pytest.mark.asyncio
async def test_hello():
    # âœ… æ¨èä½¿ç”¨ transport æ˜¾å¼ä¼ å…¥ appï¼Œé¿å… DeprecationWarning & 502 é”™è¯¯
    # å‘Šè¯‰ httpxï¼šâ€œåˆ«èµ°ç½‘ç»œäº†ï¼Œç›´æ¥é€šè¿‡ ASGI åè®®ï¼Œè°ƒç”¨ app çš„å¤„ç†é€»è¾‘ã€‚â€

    transport = ASGITransport(app=app)
    async with AsyncClient(transport=transport, base_url="http://test") as ac:
        response = await ac.get("/hello")
        assert response.status_code == 200
        assert response.json() == {"message": "Hello async!"}
```

> ASGITransport æ˜¯ httpx ä¸“é—¨ç”¨äºæµ‹è¯• FastAPIï¼ˆASGI appï¼‰çš„ä¸€ç§æœºåˆ¶ï¼Œæ¨¡æ‹Ÿ HTTP è¯·æ±‚è¿‡ç¨‹è€Œä¸éœ€è¦çœŸæ­£å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨ã€‚
> 

**ğŸ”¹ 1. FastAPI æ˜¯ ASGI åº”ç”¨**

FastAPI å®Œå…¨åŸºäº **ASGIï¼ˆAsynchronous Server Gateway Interfaceï¼‰** æ„å»ºï¼Œä¸æ˜¯ WSGIã€‚

ä½ å¹³æ—¶è¿è¡Œ FastAPI éƒ½æ˜¯é€šè¿‡ **uvicornï¼ˆASGI serverï¼‰** å¯åŠ¨çš„ã€‚

**ğŸ”¹ 2. æµ‹è¯•æ—¶ä½ å¹¶ä¸æƒ³çœŸçš„å¯åŠ¨ä¸€ä¸ªæœåŠ¡å™¨ï¼**

æˆ‘ä»¬å†™æµ‹è¯•æ—¶ï¼Œä¸å¸Œæœ›çœŸçš„å¯åŠ¨ uvicorn å¼€ä¸€ä¸ªç«¯å£æ¥è·‘æ¥å£ã€‚

è€Œæ˜¯å¸Œæœ›ï¼š

â€¢	ç›´æ¥åœ¨å†…å­˜ä¸­å‘è¯·æ±‚ç»™ app

â€¢	ä¸ç”¨å¼€ç«¯å£ã€å¼€çº¿ç¨‹ã€æç½‘ç»œ

> è¿™å°±éœ€è¦ä¸€ä¸ªâ€œæ¨¡æ‹Ÿå™¨â€ï¼Œæ¥è®© AsyncClient é€šè¿‡ app å‘è¯·æ±‚ï¼Œè€Œä¸æ˜¯é€šè¿‡ httpã€‚
> 

**âœ… æ‰€ä»¥ä¸ºä»€ä¹ˆè¦ç”¨ ASGITransportï¼Ÿ**

| **åŸå› ** | **è¯´æ˜** |
| --- | --- |
| âœ… é¿å…çœŸçš„å¯åŠ¨ HTTP æœåŠ¡ï¼ˆæ›´å¿«ï¼‰ | æµ‹è¯•è¿è¡Œé€Ÿåº¦æ›´å¿«ã€æ— éœ€ç½‘ç»œ |
| âœ… æ”¯æŒ FastAPI å…¨ç”Ÿå‘½å‘¨æœŸï¼ˆstartup/shutdownï¼‰ | é¿å…æµ‹è¯•ä¸­å‡ºç°æœªæ³¨å†Œè·¯ç”±ã€è¿æ¥æ± ç­‰é—®é¢˜ |
| âœ… æ›¿ä»£å¼ƒç”¨çš„ AsyncClient(app=app) | å®˜æ–¹æ¨èæ–¹å¼ |
| âœ… æ”¯æŒå¼‚æ­¥æµ‹è¯• (async def) | ä¸ pytest-asyncio å®Œç¾ç»“åˆ |

**ğŸ” å¼‚æ­¥ vs WSGI vs ASGI çš„åŒºåˆ«æ€»ç»“**

| **åç§°** | **ç±»å‹** | **è¯´æ˜** |
| --- | --- | --- |
| WSGI | åŒæ­¥ | Django/Flaskï¼ˆæ—§æ¥å£æ ‡å‡†ï¼‰ |
| ASGI | å¼‚æ­¥ | FastAPI/Starletteï¼ˆæ–°æ¥å£æ ‡å‡†ï¼‰ |
| Uvicorn | ASGI Server | å¯åŠ¨ FastAPI çš„æœåŠ¡å™¨ |
| ASGITransport | æ¨¡æ‹Ÿä¼ è¾“å±‚ | ä¸“é—¨ç”¨äºæµ‹è¯• ASGI åº”ç”¨ï¼Œæ— éœ€çœŸæ­£å¯åŠ¨æœåŠ¡ |

| **ç”¨æ³•** | **ç¤ºä¾‹** |
| --- | --- |
| æµ‹è¯• POST è¯·æ±‚ | client.post("/login", json={"user": "xx"}) |
| æ·»åŠ  Header / token | client.get("/me", headers={"Authorization": "Bearer xxx"}) |
| å‘é€ query å‚æ•° | client.get("/items", params={"page": 1}) |
| ä¸Šä¼ æ–‡ä»¶ | client.post("/upload", files={"file": ("name.txt", b"content")}) |
| ä½¿ç”¨ fixture æä¾› token | é…åˆ @pytest.fixture æ³¨å…¥ headers |

| **èƒ½åŠ›** | **æ”¯æŒæƒ…å†µ** |
| --- | --- |
| GET/POST/PUT/DELETE è¯·æ±‚æµ‹è¯• | âœ… æœ‰ |
| ç™»å½• token éªŒè¯ | âœ… æœ‰ |
| è·¯ç”±å‚æ•°æ ¡éªŒ | âœ… æœ‰ |
| å¼‚æ­¥æ¥å£æµ‹è¯• | âœ… æœ‰ï¼ˆç”¨ httpx.AsyncClientï¼‰ |
| æ¥å£å‰å setup æ¸…ç† | âœ… æ”¯æŒ fixture |