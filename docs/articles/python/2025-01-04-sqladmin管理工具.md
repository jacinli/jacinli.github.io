---
layout: post
title: "sqladminç®¡ç†å·¥å…·"
date: 2025-01-04
description: "sqladminç®¡ç†å·¥å…·ï¼Œä¸€ä¸ªç°ä»£ã€ä¼˜é›…çš„ SQLAlchemy ç®¡ç†åå°å·¥å…·ï¼Œéå¸¸é€‚åˆç”¨åœ¨ FastAPI é¡¹ç›®ä¸­"
tag: python
---  

# ä»‹ç»

Github å¼€æºåœ°å€ï¼š

https://github.com/aminalaee/sqladmin

ç½‘ç«™è¯´æ˜é“¾æ¥åœ°å€ï¼š

https://aminalaee.dev/sqladmin/

ä¸€ä¸ªç°ä»£ã€ä¼˜é›…çš„ SQLAlchemy ç®¡ç†åå°å·¥å…·ï¼Œéå¸¸é€‚åˆç”¨åœ¨ FastAPI é¡¹ç›®ä¸­

**SQLAdmin** æ˜¯ä¸€ä¸ªåŸºäº [FastAPI](https://fastapi.tiangolo.com/) + [SQLAlchemy](https://www.sqlalchemy.org/) æ„å»ºçš„ç®¡ç†åå°æ¡†æ¶ï¼Œçµæ„Ÿæ¥è‡ªäº Django Adminï¼Œç›®æ ‡æ˜¯ä¸º Python é¡¹ç›®æä¾›ï¼š

â€¢	ğŸš€ ç®€æ´æ˜“ç”¨çš„åå°ç•Œé¢

â€¢	ğŸ“‹ åŸºäº SQLAlchemy çš„æ¨¡å‹è‡ªåŠ¨ç®¡ç†

â€¢	âš™ï¸ å¿«é€Ÿ CRUDï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰

â€¢	âœ¨ Jinja2 æ¸²æŸ“æ¼‚äº®çš„ Bootstrap é£æ ¼åå°

| **åŠŸèƒ½** | **æè¿°** |
| --- | --- |
| ğŸ¨ UI | åŸºäº Tablerï¼ˆBootstrap é£æ ¼ï¼‰æ„å»º |
| ğŸ” CRUD è‡ªåŠ¨åŒ– | è‡ªåŠ¨æ ¹æ®æ¨¡å‹ç”Ÿæˆå¢åˆ æ”¹æŸ¥ |
| ğŸ” æœç´¢ / è¿‡æ»¤ | è¡¨å­—æ®µæœç´¢ã€è¿‡æ»¤æ”¯æŒ |
| ğŸ§© å¤šæ•°æ®åº“æ”¯æŒ | æ”¯æŒ SQLiteã€PostgreSQLã€MySQL ç­‰ |
| ğŸ” è‡ªå®šä¹‰è®¤è¯ | å¯æ‰©å±•è‡ªå®šä¹‰ç™»å½•ï¼ˆå¦‚ä½ ç”¨çš„ AdminAuthï¼‰ |
| ğŸ§  å¼‚æ­¥æ”¯æŒ | ä¸ FastAPI å®Œç¾é…åˆï¼Œæ”¯æŒå¼‚æ­¥è§†å›¾ |
| ğŸ”§ é«˜åº¦å¯é…ç½® | æ”¯æŒåˆ—éšè—ã€æ ¼å¼åŒ–ã€æ ‡ç­¾ç­‰é…ç½®é¡¹ |

æ”¯æŒmodels çš„ç±»å‹ï¼š

| âœ… æ”¯æŒ SQLAlchemy å—ï¼Ÿ | æ˜¯ï¼Œ**å¿…é¡»åŸºäº SQLAlchemy ORM** æ¨¡å‹ |
| --- | --- |
| âœ… æ”¯æŒ SQLAlchemy 1.x å—ï¼Ÿ | æ˜¯ |
| âœ… æ”¯æŒ SQLAlchemy 2.x å—ï¼Ÿ | æ˜¯ï¼Œä» sqladmin 0.15.0+ å¼€å§‹å…¨é¢æ”¯æŒ |
| âŒ æ”¯æŒ Tortoise ORM å—ï¼Ÿ | ä¸æ”¯æŒ |
| âŒ æ”¯æŒ Django ORM å—ï¼Ÿ | ä¸æ”¯æŒ |

# ä¸ºä»€ä¹ˆä½¿ç”¨ï¼Ÿ

å¾ˆå¤šé¡¹ç›®éƒ½æ˜¯å¼‚æ­¥ï¼Œè€Œå¼‚æ­¥é‡Œé¢ORM æ€§èƒ½æœ€å¥½çš„å°±æ˜¯Â **SQLAlchemy 2.0**Â  

| **ç‰¹æ€§** | **ä¼˜åŠ¿** | **æ˜¯å¦æ¨è** |
| --- | --- | --- |
| âœ… æ–°çš„ 2.0 é£æ ¼è¯­æ³• | æ›´æ¸…æ™°ã€ç±»å‹å®‰å…¨ï¼Œç»Ÿä¸€ async / sync ç”¨æ³• | å¼ºçƒˆæ¨è |
| âœ… åŸç”Ÿå¼‚æ­¥æ”¯æŒï¼ˆasync_engineï¼‰ | é€‚é… FastAPIã€aiohttp ç­‰å¼‚æ­¥æ¡†æ¶ | âœ” |
| âœ… Declarative Mapping æ›´åŠ æ¸…æ™° | ä¸å†æ··ç”¨ Base = declarative_base() å’Œ mapper() | âœ” |
| âœ… æ›´å¼ºçš„ç±»å‹æç¤ºæ”¯æŒ | IDE å‹å¥½ï¼Œè°ƒè¯•æ›´èˆ’æœ | âœ” |
| âœ… Session è¯­ä¹‰æ”¹è¿› | æ˜¾å¼äº‹åŠ¡æ§åˆ¶ã€æ›´åŠ å®‰å…¨ | âœ” |
| âœ… å®˜æ–¹é•¿æœŸç»´æŠ¤æ–¹å‘ | æ‰€æœ‰æ–°åŠŸèƒ½åªåœ¨ 2.x ä¸Šæ›´æ–° | âœ” |

| **ç‰¹æ€§ / æ¡†æ¶** | **SQLAlchemy 2.0 (async)** | **Tortoise ORM** | **asyncpg (åŸç”Ÿé©±åŠ¨)** |
| --- | --- | --- | --- |
| â­ å¼‚æ­¥æ”¯æŒ | âœ… åŸç”Ÿ async APIï¼ˆ2.0 èµ·ï¼‰ | âœ… åŸç”Ÿ async | âœ… åŸç”Ÿ async |
| ğŸ¯ ORM æ”¯æŒ | âœ… å®Œæ•´ ORMï¼ˆç»å…¸ + å£°æ˜å¼ï¼‰ | âœ… ç±» Django çš„ ORM | âŒ æ²¡æœ‰ ORMï¼Œéœ€æ‰‹å†™ SQL |
| âš™ï¸ äº‹åŠ¡å¤„ç† | âœ… async with session.begin() | âœ… transaction() ä¸Šä¸‹æ–‡ | âœ… éœ€æ‰‹åŠ¨å†™ SQL + äº‹åŠ¡å¤„ç† |
| ğŸ”§ çµæ´»æ€§ | âœ… é«˜ï¼ˆæ”¯æŒ ORM + Coreï¼‰ | ä¸­ç­‰ï¼ˆORMé£æ ¼è¾ƒå›ºå®šï¼‰ | æé«˜ï¼ˆæœ€è´´è¿‘ SQLï¼‰ |
| ğŸ“š å­¦ä¹ æ›²çº¿ | ç¨é«˜ï¼ˆä½†æ–‡æ¡£å…¨ï¼‰ | è¾ƒä½ï¼Œé€‚åˆ Django ç”¨æˆ· | ä¸­ç­‰ï¼ˆéœ€æŒæ¡ SQLï¼‰ |
| ğŸš€ æ€§èƒ½ | ä¼˜ï¼ˆåˆç†ç”¨ asyncï¼‰ | ä¼˜ï¼ˆè½»é‡ï¼‰ | **æœ€ä¼˜ï¼ˆç›´æ¥æ“ä½œ protocolï¼‰** |
| âœ… ç±»å‹æ”¯æŒ | âœ… Pydantic é…åˆè‰¯å¥½ | âœ… ä¹Ÿèƒ½é…åˆ Pydantic ä½¿ç”¨ | âŒ æ— è‡ªåŠ¨è½¬æ¢ï¼Œæ‰‹åŠ¨å¤„ç† |
| ğŸ§© æ”¯æŒçš„æ•°æ®åº“ | å¤šï¼ˆPostgreSQL, MySQL, SQLiteç­‰ï¼‰ | PostgreSQLã€MySQLã€SQLite | PostgreSQL ä¸“ç”¨ |
| ğŸ” ç¤¾åŒº & æ–‡æ¡£ | éå¸¸æˆç†Ÿï¼ˆå®˜æ–¹é•¿æœŸç»´æŠ¤ï¼‰ | æ´»è·ƒï¼Œåå°ä¼— | å®˜æ–¹æ˜¯ PostgreSQL çš„æ¨èé©±åŠ¨ |

| **ä½ çš„éœ€æ±‚** | **æ¨èæ–¹æ¡ˆ** |
| --- | --- |
| éœ€è¦å¼ºå¤§çš„ ORM + ç±»å‹æ£€æŸ¥ + å¯æ‰©å±•æ€§ | âœ… **SQLAlchemy 2.0 + Async** |
| æƒ³å¿«é€Ÿä¸Šæ‰‹ã€æœ‰ Django ORM èƒŒæ™¯ | âœ… **Tortoise ORM** |
| è¦æè‡´æ€§èƒ½ï¼Œæ‰‹å†™ SQL ä¸æ€•éº»çƒ¦ | âœ… **asyncpg** |

# ç»“åˆåº”ç”¨

```python
from sqlalchemy import Column, Integer, String, create_engine,Enum as SAEnum,JSON
from sqladmin.authentication import AuthenticationBackend
import json
import hashlib
from sqlalchemy import event

from sqlalchemy.orm import declarative_base
from enum import Enum
from sqlalchemy.ext.hybrid import hybrid_property

Base = declarative_base()
engine = create_engine(
    "sqlite:///example.db",
    connect_args={"check_same_thread": False},
)

# å®šä¹‰æšä¸¾ç±»å‹
class GenderEnum(str, Enum):
    MALE = "male"
    FEMALE = "female"
    OTHER = "other"

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    name = Column(String)
    gender = Column(SAEnum(GenderEnum), nullable=False, comment="æ€§åˆ«")
    password = Column("password", String, nullable=False)  # çœŸå®å­˜å‚¨åŠ å¯†åçš„å¯†ç 

class JsonConfig(Base):
    __tablename__ = "json_config"

    id = Column(Integer, primary_key=True)
    name = Column(String)
    config = Column(JSON)

Base.metadata.create_all(engine)  # Create tablesï¼Œåé¢æ”¹äº†å­—æ®µéœ€è¦åˆ é™¤

from fastapi import FastAPI
from sqladmin import Admin, ModelView
from fastapi import Request

app = FastAPI()

class AdminAuth(AuthenticationBackend):
    async def login(self, request: Request) -> bool:
        form = await request.form()
        username, password = form["username"], form["password"]

        # Validate username/password credentials
        # And update session
        if username == "admin" and password == "123456":
            request.session.update({"sqladmin_token": "..."})
            return True
        else:
            return False
        return True

    async def logout(self, request: Request) -> bool:
        # Usually you'd want to just clear the session
        request.session.clear()
        return True

    async def authenticate(self, request: Request) -> bool:
        token = request.session.get("sqladmin_token")

        if not token:
            return False

        # Check the token in depth
        return True

authentication_backend = AdminAuth(secret_key="secret_key")

admin = Admin(app, engine,base_url="/super",authentication_backend=authentication_backend)

class UserAdmin(ModelView, model=User):
    self_md5_salt = "123456"
    column_list = [User.id, User.name,User.gender,User.password]

    # è‡ªå®šä¹‰åˆ—æ ‡ç­¾ï¼ˆè®© SQLAdmin UI æ˜¾ç¤ºä¸­æ–‡ï¼‰
    column_labels = {
        "id": "ç”¨æˆ· ID",
        "name": "å§“å",
        "gender": "æ€§åˆ«",
        "password": "å¯†ç ",
    }
    async def insert_model(self, request: Request, data: dict):
        """æ‹¦æˆªæ’å…¥é€»è¾‘ï¼Œç¡®ä¿ `password` ç»è¿‡ MD5 åŠ å¯†"""
        raw_password = data.pop("password", None)
        if raw_password:
            data["password"] = hashlib.md5((raw_password+self.self_md5_salt).encode()).hexdigest()
        return await super().insert_model(request, data)

    async def update_model(self, request: Request, pk: str, data: dict):
        """æ‹¦æˆªæ›´æ–°é€»è¾‘ï¼Œç¡®ä¿ `password` ç»è¿‡ MD5 åŠ å¯†"""
        raw_password = data.pop("password", None)
        if raw_password:
            data["password"] = hashlib.md5((raw_password+self.self_md5_salt).encode()).hexdigest()
        return await super().update_model(request, pk, data)

class JsonConfigAdmin(ModelView, model=JsonConfig): 
    column_list = [JsonConfig.id, JsonConfig.name,JsonConfig.config]
    # å‰ç«¯é¡µé¢æ’å…¥çš„æ—¶å€™ åªèƒ½ä½¿ç”¨åŒå¼•å·çš„json ä¸èƒ½ä½¿ç”¨å•å¼•å·çš„json

admin.add_view(UserAdmin)
admin.add_view(JsonConfigAdmin)

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="127.0.0.1", port=8000)
# uvicorn test_sqladmin:app --host 127.0.0.1 --port 8000 --reload
# åå°åœ°å€ï¼š http://127.0.0.1:8000/super

# pip install itsdangerous  sqladmin 
```