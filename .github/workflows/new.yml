name: Docker Image CI Blog

on:
  push:
    branches: [ "new" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build VuePress project
        run: |
          export NODE_OPTIONS="--openssl-legacy-provider"
          yarn build
        env:
          NODE_OPTIONS: "--openssl-legacy-provider"

      - name: Verify build output
        run: |
          echo "ğŸ“ æ£€æŸ¥æ„å»ºè¾“å‡º..."
          ls -la docs/.vuepress/dist/
          echo "âœ… æ„å»ºå®Œæˆ"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER_NAME }}
          password: ${{ secrets.DOCKER_USER_PASSWORD }}

      - name: Build and push Docker image to Docker Hub
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_USER_NAME }}/blog:main

          echo "ğŸ› ï¸ æ„å»ºé•œåƒ $IMAGE_NAME"
          docker build . \
            --file Dockerfile \
            --tag $IMAGE_NAME

          echo "ğŸš€ æ¨é€é•œåƒåˆ° Docker Hub"
          docker push $IMAGE_NAME


      - name: SSH into server and update services
        run: |
            echo "ğŸ” SSH è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼Œå‡†å¤‡éƒ¨ç½²..."
  
            sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no -p "${{ secrets.SERVER_PORT }}" "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_PROD_IP }}" <<'EOF'
                echo "ğŸš€ å·²è¿›å…¥æœåŠ¡å™¨ï¼Œå¼€å§‹æ›´æ–°æœåŠ¡..."
                cd /root/blog/
                bash up.sh
                echo "âœ… åšå®¢æ›´æ–°å®Œæˆï¼"
            EOF