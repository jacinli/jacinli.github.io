---
layout: post
title: "mysqlé”™è¯¯ç  2013 è§£å†³æ–¹æ¡ˆ"
date: 2025-05-26
description: "mysqlé”™è¯¯ç  2013 è§£å†³æ–¹æ¡ˆ"
tag: æ•°æ®åº“
---


ä»¥ä¸‹çš„æ–¹æ¡ˆæ˜¯ **è„šæœ¬è¿è¡Œåœºæ™¯ä¸‹** æ˜¯ä¸€ä¸ªéå¸¸åˆç†çš„ **è½»é‡çº§è¿æ¥ç®¡ç†æ–¹æ¡ˆã€‚ã€ä¸æ˜¯ç‰¹å®šæ¥å£ä¸‹ï¼Œè€Œæ˜¯é¢å¯¹é•¿æ—¶é—´åœ°è¯»å†™æ•°æ®åº“çš„è„šæœ¬æ“ä½œã€‘**

æœ‰å¾ˆå¤šæ—¶å€™ æœ‰è¿™æ ·çš„æƒ…å†µå‘ç”Ÿï¼Œå°±æ˜¯ç”¨è„šæœ¬å»çˆ¬æŸä¸ªæœåŠ¡ï¼Œéœ€è¦æŒç»­ä¸æ–­åœ°å†™æ•°æ®åº“ï¼Œä½†æ˜¯è¿è¡Œä¸€æ®µæ—¶é—´åå‡ºç°äº†è¿™æ ·çš„é”™è¯¯ï¼š

```jsx
(2013, 'Lost connection to MySQL server during query')
```

è¿™æ˜¯ **MySQL å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ Pythonã€Goã€Djangoã€GORM ç­‰ï¼‰åœ¨æ‰§è¡Œ SQL æœŸé—´ä¸ MySQL æœåŠ¡ç«¯çš„è¿æ¥ä¸­æ–­**ï¼Œæ˜¯ **MySQL ç»å…¸é”™è¯¯ç  2013**ã€‚

- å®¢æˆ·ç«¯å·²ç»æˆåŠŸè¿ä¸Šäº†æ•°æ®åº“ï¼›
- å‘èµ·äº†ä¸€ä¸ª SQL æŸ¥è¯¢ï¼›
- **åœ¨æŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿æ¥æ–­æ‰äº†**ï¼›
- ç„¶åå°±æŠ›å‡ºäº† (2013, 'Lost connection to MySQL server during query')ã€‚

å‘ç”Ÿçš„ç°è±¡ï¼š

**1.æŸ¥è¯¢è€—æ—¶è¿‡é•¿ï¼Œè¶…æ—¶æ–­å¼€**

- ä¾‹å¦‚æ‰§è¡Œäº†ä¸€ä¸ªå¤§ SQL æˆ–æ…¢æŸ¥è¯¢ï¼Œè¶…è¿‡äº†æœåŠ¡å™¨è®¾ç½®çš„ net_read_timeout æˆ– net_write_timeoutã€‚
- é»˜è®¤ MySQL çš„è¶…æ—¶æ—¶é—´æœ‰äº›æ¯”è¾ƒçŸ­ï¼ˆæ¯”å¦‚ 30 ç§’ï¼‰ã€‚

**2.ç½‘ç»œä¸­æ–­**

- å®¹å™¨é‡å¯ã€æœåŠ¡å™¨çŸ­æš‚æ–­ç½‘ã€Docker/Pod å¶å‘ kill ç­‰ï¼›
- å®¹å™¨ä¹‹é—´ç½‘ç»œä¸ç¨³å®šï¼Œå°¤å…¶æ˜¯è·¨èŠ‚ç‚¹é€šä¿¡æ—¶ã€‚

**3.MySQL æœåŠ¡ç«¯å´©æºƒæˆ– kill**

- MySQL æœ¬èº«å®•æœºäº†ï¼›
- è¢«å¤–éƒ¨ OOM æˆ– kill -9ï¼›
- æˆ–è€…æœåŠ¡è‡ªåŠ¨é‡å¯ï¼ˆå¦‚ K8s liveness probe è§¦å‘ï¼‰ã€‚

**4.è¿æ¥æ± ä¸­æ–­ä½†æ²¡æ£€æµ‹å‡ºæ¥**

- å®¢æˆ·ç«¯å¤ç”¨äº†ä¸€ä¸ªè¿æ¥æ± ä¸­å·²å¤±æ•ˆçš„è¿æ¥ï¼›
- å½“è°ƒç”¨æ—¶æ‰å‘ç°å…¶å®è¿æ¥æ—©å°±æ–­äº†ã€‚

**5.MySQL è®¾ç½®è¿æ¥è¶…æ—¶ï¼ˆwait_timeoutã€interactive_timeoutï¼‰**

- æŸè¿æ¥ç©ºé—²å¤ªä¹…ï¼Œè¢«æœåŠ¡ç«¯æ–­æ‰äº†ï¼›
- å°¤å…¶æ˜¯åœ¨è¿æ¥æ± ä¸­é‡ç”¨æ—§è¿æ¥çš„æ—¶å€™ã€‚

ä½†æ˜¯æˆ‘çš„ä»£ç  éƒ½æ²¡æœ‰è¿™æ ·çš„æƒ…å†µï¼Œä¸è¿‡æˆ‘çš„ä»£ç å› ä¸ºæ˜¯çº¯ sqlï¼Œæ¯ä¸€ä¸ªå‡½æ•°éƒ½ä¼šæ‰‹åŠ¨å¼€å¯æ•°æ®åº“å…³é—­æ•°æ®åº“æ–¹å¼ï¼Œè¿™å°±æ˜¯å¯¼è‡´äº†é¢‘ç¹è¿æ¥å’Œé‡Šæ”¾æ•°æ®åº“ï¼Œè¿™ä¹Ÿæ˜¯ä¼šå¯¼è‡´ 2013çš„åŸå› ã€‚

# **âœ… ä¸ºä»€ä¹ˆé¢‘ç¹è¿æ¥/å…³é—­ä¼šå¯¼è‡´ 2013 é”™è¯¯ï¼Ÿ**

**ğŸ“ åŸå› ä¸€ï¼šè¿æ¥å°šæœªå®Œå…¨å»ºç«‹æˆ–è¢«æœåŠ¡ç«¯æ‹’ç»æ—¶å‘èµ·æŸ¥è¯¢**

- MySQL å»ºç«‹è¿æ¥æ˜¯æœ‰æˆæœ¬çš„ï¼ˆTCPæ¡æ‰‹ã€è®¤è¯ã€åˆå§‹åŒ–ç¯å¢ƒï¼‰ï¼›
- å¦‚æœä½ åˆšæ‰“å¼€è¿æ¥å°±é©¬ä¸Šå‘æŸ¥è¯¢ï¼Œè€Œè¿™ä¸ªè¿æ¥åº•å±‚å°šæœª readyï¼Œå¯èƒ½å°±å‡ºç°â€œè¿æ¥ä¸­æ–­â€ï¼›
- æ›´æç«¯çš„æ˜¯ MySQL æš‚æ—¶æ— æ³•å¤„ç†æ–°çš„è¿æ¥ï¼ˆè¿æ¥æ•°è¿‡å¤šã€ä¸´æ—¶å‹åŠ›é«˜ï¼‰ï¼Œä¹Ÿä¼šå‡ºç°è¿æ¥æŠ›é”™ã€‚

**ğŸ“ åŸå› äºŒï¼šé¢‘ç¹åˆ›å»ºè¿æ¥ï¼Œå®¹æ˜“è¶…å‡ºè¿æ¥æ•°é™åˆ¶æˆ–å¼•å‘èµ„æºç´§å¼ **

- MySQL é»˜è®¤æœ€å¤§è¿æ¥æ•°æœ‰é™åˆ¶ï¼Œæ¯”å¦‚ max_connections = 151ï¼›
- å¦‚æœä½ çš„ç¨‹åºé«˜å¹¶å‘ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½åˆ›å»ºè¿æ¥ä¸å¤ç”¨ï¼Œå®¹æ˜“è§¦å‘æœåŠ¡å™¨èµ„æºå¼‚å¸¸ï¼Œå¯¼è‡´è¿æ¥å¤±è´¥ã€æ•°æ®ä¼ è¾“ä¸­æ–­ç­‰ã€‚

**ğŸ“ åŸå› ä¸‰ï¼šè¿æ¥å…³é—­å¾—å¤ªæ—©æˆ–æŸ¥è¯¢æœªç»“æŸå³å…³é—­**

- æŸäº›åœ°æ–¹å…³é—­è¿æ¥å¤ªæ—©ï¼Œç”šè‡³åœ¨å¼‚æ­¥ä»»åŠ¡æˆ–æŸ¥è¯¢è¿˜æ²¡æ‹¿åˆ°ç»“æœå°± conn.close()ï¼Œä¼šå¯¼è‡´ï¼š

å› ä¸ºæˆ‘æ˜¯è„šæœ¬è¿è¡Œçš„ï¼Œæ‰€ä»¥æœ‰å¾ˆå¤§æ¦‚ç‡ä¼šé€ æˆè¿™ä¸ªç°è±¡ï¼Œä¹‹å‰æ²¡æœ‰å½»åº•è§£å†³ï¼Œå°±æ˜¯å¯¹æ¯ä¸ªæ•°æ®åº“æ“ä½œç›´æ¥ sleep ä¸‹ï¼Œé¿å…çŸ­æ—¶é—´é¢‘ç¹åˆ›å»ºï¼Œä½†æ˜¯è¿˜æ˜¯å‘ç°æ²»æ ‡ä¸æ²»æœ¬ï¼Œå› ä¸ºè¿è¡Œå¤ªæ…¢äº†ã€‚

æ‰€ä»¥æˆ‘é‡‡å–äº†ä»¥ä¸‹çš„è§£å†³åŠæ³•ã€‚

å› ä¸ºæˆ‘åœ¨æ¯ä¸ªå‡½æ•°å‚æ•°é‡Œé¢ æ²¡æœ‰åŠ  session çš„å†…å®¹ï¼Œå¦‚æœå¯¹æ¯ä¸ªå‡½æ•°è¿™æ ·æ›´æ”¹ï¼Œæˆæœ¬å¤ªé«˜ å®¹æ˜“å‡ºé”™ï¼Œå¯¹æ¶‰åŠçš„å‡½æ•°è¿˜éœ€è¦æ”¹åŠ æµ‹è¯•ã€‚

# å…¨å±€ç®¡ç†+å®šæ—¶é‡Šæ”¾

æ‰€ä»¥é‡‡å–äº†å…¨å±€å˜é‡+ å®šæ—¶é‡Šæ”¾çš„é€»è¾‘æ“ä½œã€‚

```jsx
from libs.sync_mysql_sdk import SyncMySQLSDK
from report.db_source import dsn
from utils.time_convert import get_month_start_and_end_datetime
import time
import threading

# ğŸ”¥ å…¨å±€å•ä¾‹è¿æ¥æ± ç®¡ç†å™¨
class DBManager:
    def __init__(self):
        self._mirror_sdk = None
        self._saas_sdk = None
        self._last_use_time = time.time()
        self._lock = threading.Lock()
        self._timeout = 30  # 5åˆ†é’Ÿç©ºé—²å°±é‡Šæ”¾è¿æ¥

    def get_dsn_sdk(self):
        with self._lock:
            if self._mirror_sdk is None:
                self._mirror_sdk = SyncMySQLSDK(
                    dsn=mirror_dsn,
                    min_size=1,
                    max_size=5,
                    read_timeout=60
                )
                self._mirror_sdk.connect()
                print("åˆ›å»º mirror æ•°æ®åº“è¿æ¥")

            self._last_use_time = time.time()
            return self._mirror_sdk

                

    def check_and_release(self):
        """æ£€æŸ¥å¹¶é‡Šæ”¾ç©ºé—²è¿æ¥"""
        with self._lock:
            current_time = time.time()
            if current_time - self._last_use_time > self._timeout:
                if self._mirror_sdk:
                    self._mirror_sdk.close()
                    self._mirror_sdk = None
                    print("é‡Šæ”¾ mirror æ•°æ®åº“è¿æ¥")

                if self._saas_sdk:
                    self._saas_sdk.close()
                    self._saas_sdk = None
                    print("é‡Šæ”¾ saas æ•°æ®åº“è¿æ¥")

    def force_release(self):
        """å¼ºåˆ¶é‡Šæ”¾æ‰€æœ‰è¿æ¥"""
        with self._lock:
            if self._mirror_sdk:
                self._mirror_sdk.close()
                self._mirror_sdk = None
                print("å¼ºåˆ¶é‡Šæ”¾ mirror æ•°æ®åº“è¿æ¥")

            if self._saas_sdk:
                self._saas_sdk.close()
                self._saas_sdk = None
                print("å¼ºåˆ¶é‡Šæ”¾ saas æ•°æ®åº“è¿æ¥")

# ğŸ”¥ å…¨å±€å•ä¾‹å®ä¾‹
_db_manager = DBManager()

# ğŸ”¥ ç®€å•çš„æ¥å£å‡½æ•°
def get_dsn_sdk():
    return _db_manager.get_dsn_sdk()

def release_idle_connections():
    """é‡Šæ”¾ç©ºé—²è¿æ¥ - åœ¨ä½ çš„ä¸»ç¨‹åºé‡Œå®šæœŸè°ƒç”¨"""
    _db_manager.check_and_release()

def force_release_all():
    """å¼ºåˆ¶é‡Šæ”¾æ‰€æœ‰è¿æ¥ - ç¨‹åºç»“æŸæ—¶è°ƒç”¨"""
    _db_manager.force_release()

```

æ¯ä¸ªæ•°æ®åº“æ“ä½œçš„å‡½æ•°ç›´æ¥å»è°ƒç”¨get_dsn_sdk() è¿™ä¸ªå‡½æ•°å°±å¯ä»¥æ‹¿åˆ°è¿™ä¸ªæ–¹æ³•äº†ã€‚

ç„¶åå¯¹äºæŒ‰å¤©æ“ä½œçš„æ•°æ®åº“åœ¨ for å¾ªç¯å¼€å§‹release_idle_connections() æ‰‹åŠ¨å»é‡Šæ”¾ç©ºé—´ï¼ŒåŒæ—¶è®¾ç½®äº† timeout æ˜¯ 30s,è¿™æ ·ä¸¤ä¸ªæ–¹é¢å¯ä»¥é¿å…æ•°æ®åº“é•¿æ—¶é—´çš„è¿æ¥é—®é¢˜äº†ã€‚

**âœ… 1.è§£å†³äº†é¢‘ç¹è¿æ¥é‡Šæ”¾çš„é—®é¢˜**

- é¿å…æ¯ä¸ªå‡½æ•°éƒ½é‡æ–° .connect()ï¼Œå¤§å¤§é™ä½äº†æ•°æ®åº“è¿æ¥å»ºç«‹çš„æˆæœ¬ã€‚
- é€šè¿‡å…¨å±€å˜é‡ + å•ä¾‹ç®¡ç†ï¼Œä¿æŒäº†è¿æ¥çš„**å¤ç”¨æ€§**ï¼Œè¿™æ˜¯è§£å†³ 2013 çš„å…³é”®ã€‚

**âœ… 2.å°è£…äº† SDK è·å–é€»è¾‘**

- è°ƒç”¨è€…åªéœ€è¦ get_dsn_sdk()ï¼Œ**å±è”½äº†è¿æ¥åˆ›å»º/é‡Šæ”¾çš„ç»†èŠ‚**ï¼Œæå‡äº†ä»£ç å¤ç”¨æ€§å’Œå®‰å…¨æ€§ã€‚

**âœ… 3.æä¾›äº†å®šæœŸè‡ªåŠ¨é‡Šæ”¾æœºåˆ¶**

- check_and_release() + _timeout æœºåˆ¶ï¼Œæ˜¯éå¸¸åˆç†çš„**ç©ºé—²è¿æ¥å›æ”¶ç­–ç•¥**ï¼Œé˜²æ­¢è¿æ¥æ³„æ¼ã€‚
- ä½ è¿˜é¢å¤–æš´éœ²äº† force_release_all() ç”¨äºè„šæœ¬é€€å‡ºæ¸…ç†ï¼Œéå¸¸ä¸¥è°¨ã€‚

**âœ… 4.åŠ äº†çº¿ç¨‹é” threading.Lock()**

- å¦‚æœä½ çš„è„šæœ¬æ˜¯å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„ï¼Œè¿™ç‚¹å°¤å…¶é‡è¦ï¼Œé˜²æ­¢è¿æ¥çŠ¶æ€è¢«å¹¶å‘è¯»å†™æ±¡æŸ“ã€‚